{
  "version": "Notebook/1.0",
  "items": [
    {
      "type": 9,
      "content": {
        "version": "KqlParameterItem/1.0",
        "parameters": [
          {
            "id": "317b96be-f4d1-4b64-801f-9fdf48799e9a",
            "version": "KqlParameterItem/1.0",
            "name": "SentinelWorkspace",
            "label": "Workspace",
            "type": 5,
            "isRequired": true,
            "typeSettings": {
              "resourceTypeFilter": {
                "microsoft.operationalinsights/workspaces": true
              },
              "additionalResourceOptions": []
            }
          },
          {
            "id": "4ed0e6fb-0c19-4ade-ab13-095cd8a54966",
            "version": "KqlParameterItem/1.0",
            "name": "IncidentNumber",
            "label": "Incident Number",
            "type": 1,
            "description": "Taken from the URL by default but can be changed",
            "isRequired": true,
            "timeContext": {
              "durationMs": 86400000
            }
          },
          {
            "id": "606c4a1e-7de7-4f5e-815e-920df5e429c5",
            "version": "KqlParameterItem/1.0",
            "name": "IncidentInfo",
            "type": 1,
            "query": "SecurityIncident\r\n| where TimeGenerated > ago(90d)\r\n| where IncidentNumber  == {IncidentNumber}\r\n| summarize arg_max(TimeGenerated, * ) by IncidentNumber\r\n| mv-expand AlertId = AlertIds\r\n| extend AlertId = tostring(AlertId)\r\n| join (\r\n    SecurityAlert\r\n    | where TimeGenerated > ago(90d)\r\n    | summarize arg_max(TimeGenerated, * ) by SystemAlertId\r\n) on $left.AlertId == $right.SystemAlertId\r\n| summarize Alerts = make_set(AlertName), ListAlerts = make_set(SystemAlertId) by IncidentNumber, IncidentUrl, Severity, Status, LastModifiedTime, IncidentName, FirstActivityTime, LastActivityTime \r\n| project IncidentUrl, Alerts, Severity, Status, LastModifiedTime, IncidentName, ListAlerts, FirstActivityTime, LastActivityTime \r\n| extend Info = pack_all()\r\n| project Info",
            "crossComponentResources": [
              "{SentinelWorkspace}"
            ],
            "isHiddenWhenLocked": true,
            "queryType": 0,
            "resourceType": "microsoft.operationalinsights/workspaces"
          },
          {
            "id": "1886283b-a17c-4286-ba91-20278e99afa0",
            "version": "KqlParameterItem/1.0",
            "name": "WorkbookCheck",
            "type": 1,
            "query": "SecurityIncident\r\n| where TimeGenerated > ago(90d)\r\n| where IncidentNumber  == {IncidentNumber}\r\n| summarize arg_max(TimeGenerated, * ) by IncidentNumber\r\n| mv-expand AlertId = AlertIds\r\n| extend AlertId = tostring(AlertId)\r\n| join (\r\n    SecurityAlert\r\n    | where TimeGenerated > ago(90d)\r\n    | summarize arg_max(TimeGenerated, * ) by SystemAlertId\r\n) on $left.AlertId == $right.SystemAlertId\r\n| where AlertName contains \"TI Map IP Entity to AzureActivity\"\r\n| count\r\n| project tostring(Count)",
            "crossComponentResources": [
              "{SentinelWorkspace}"
            ],
            "isHiddenWhenLocked": true,
            "queryType": 0,
            "resourceType": "microsoft.operationalinsights/workspaces"
          },
          {
            "id": "be11aa0d-5be0-4a2c-9ee2-2fe67215ec59",
            "version": "KqlParameterItem/1.0",
            "name": "ShowHelp",
            "label": "Show Help",
            "type": 2,
            "isRequired": true,
            "typeSettings": {
              "additionalResourceOptions": [],
              "showDefault": false
            },
            "jsonData": "[\r\n    {\"value\":\"Yes\",\"label\":\"Yes\", \"selected\":false},\r\n    {\"value\":\"No\",\"label\":\"No\", \"selected\":true}\r\n]"
          }
        ],
        "style": "pills",
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces"
      },
      "name": "TopParameters"
    },
    {
      "type": 1,
      "content": {
        "json": "This workbook was created to help triage and investigate incident generated by the \"TI Map IP Entity to AzureActivity\" analytic rule.\r\nYou can still use this workbook with other incident types but the data presented might not match your need 🤷",
        "style": "warning"
      },
      "conditionalVisibility": {
        "parameterName": "WorkbookCheck",
        "comparison": "isEqualTo",
        "value": "0"
      },
      "name": "AlertTypeMismatchWarning"
    },
    {
      "type": 1,
      "content": {
        "json": "You can navigate to users and IP addresses of this incident by clicking on the navigation tabs below.",
        "style": "info"
      },
      "conditionalVisibility": {
        "parameterName": "ShowHelp",
        "comparison": "isEqualTo",
        "value": "Yes"
      },
      "name": "ItemSelectionHelp"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 9,
            "content": {
              "version": "KqlParameterItem/1.0",
              "crossComponentResources": [
                "{SentinelWorkspace}"
              ],
              "parameters": [
                {
                  "id": "a7217355-bebd-4088-9020-a6b0c3dde71b",
                  "version": "KqlParameterItem/1.0",
                  "name": "Account",
                  "type": 11,
                  "isRequired": true,
                  "query": "SecurityIncident\r\n| where TimeGenerated > ago(90d)\r\n| where IncidentNumber  == {IncidentNumber}\r\n| summarize arg_max(TimeGenerated, * ) by IncidentNumber\r\n| mv-expand AlertId = AlertIds\r\n| extend AlertId = tostring(AlertId)\r\n| join (\r\n    SecurityAlert\r\n    | where TimeGenerated > ago(90d)\r\n    | summarize arg_max(TimeGenerated, * ) by SystemAlertId\r\n) on $left.AlertId == $right.SystemAlertId\r\n| mv-apply todynamic(Entities) on (\r\n    where Entities.Type =~ \"account\"\r\n)\r\n| extend AccountName = tolower(tostring(Entities.Name)), UPNSuffix = tolower(tostring(Entities.UPNSuffix))\r\n| lookup (IdentityInfo | where TimeGenerated > ago(14d) | summarize arg_max(TimeGenerated, AccountUPN, AccountDisplayName, AccountName) by AccountObjectId | extend AccountDisplayName = tolower(AccountDisplayName), UPNSuffix = tolower(tostring(split(AccountUPN,\"@\")[1]))) on $left.AccountName == $right.AccountName, UPNSuffix\r\n| distinct AccountUPN\r\n| serialize Rank = row_number()\r\n| project label = AccountUPN, value = AccountUPN, selected = iff(Rank == 1, true, false)\r\n| where isnotempty(label)\r\n",
                  "crossComponentResources": [
                    "{SentinelWorkspace}"
                  ],
                  "typeSettings": {
                    "additionalResourceOptions": [],
                    "showDefault": false
                  },
                  "queryType": 0,
                  "resourceType": "microsoft.operationalinsights/workspaces"
                },
                {
                  "id": "a56f33c9-f880-41b2-b8de-421b729028a8",
                  "version": "KqlParameterItem/1.0",
                  "name": "AccountDetails",
                  "type": 1,
                  "query": "IdentityInfo\r\n| where TimeGenerated > ago(14d)\r\n| where AccountUPN =~ \"{Account:label}\"\r\n| summarize arg_max(TimeGenerated, *) by AccountObjectId\r\n| extend IsPrivileged = iif(array_length(AssignedRoles) == 0, false, true)\r\n| extend Data = pack_all()\r\n| project Data",
                  "crossComponentResources": [
                    "{SentinelWorkspace}"
                  ],
                  "isHiddenWhenLocked": true,
                  "queryType": 0,
                  "resourceType": "microsoft.operationalinsights/workspaces"
                }
              ],
              "style": "pills",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces"
            },
            "name": "IncidentParameters - Copy"
          },
          {
            "type": 1,
            "content": {
              "json": "## 👤  {AccountDetails:$.AccountDisplayName} - {AccountDetails:$.JobTitle}\r\n\r\n**📃 Department** {AccountDetails:$.Department} ({AccountDetails:$.CompanyName})     \r\n**💥 Blast radius** {AccountDetails:$.BlastRadius}   \r\n**👑 Is Privileged** {AccountDetails:$.IsPrivileged}   \r\n**✉️ UPN** {AccountDetails:$.AccountUPN}   \r\n**👩‍💼 Manager** {AccountDetails:$.Manager}   \r\n**🌎 Location** {AccountDetails:$.City} {AccountDetails:$.State} {AccountDetails:$.Country}   \r\n**📧 Mail** {AccountDetails:$.MailAddress}   \r\n**☎️ Phone** {AccountDetails:$.Phone}   \r\n**👩‍💼 Manager** {AccountDetails:$.Manager}   \r\n"
            },
            "name": "AccountDetailsText"
          },
          {
            "type": 11,
            "content": {
              "version": "LinkItem/1.0",
              "style": "toolbar",
              "links": [
                {
                  "id": "fb47fe19-4692-4ce5-af8a-f492fffa282f",
                  "cellValue": "",
                  "linkTarget": "OpenBlade",
                  "linkLabel": "Entra ID Portal Sign-In info",
                  "postText": "Click here to see the Activity in the Entra ID portal",
                  "style": "link",
                  "icon": "Monitoring",
                  "linkIsContextBlade": true,
                  "bladeOpenContext": {
                    "bladeName": "UserProfileMenuBlade",
                    "extensionName": "Microsoft_AAD_UsersAndTenants",
                    "bladeJsonParameters": "{\n  \"menuId\": \"SignIns\",\n  \"userId\": \"{AccountDetails:$.AccountObjectId}\",\n  \"hidePreviewBanner~\": true\n}"
                  }
                },
                {
                  "id": "573bed15-ee6e-450f-a65e-437f9dbd7260",
                  "linkTarget": "OpenBlade",
                  "linkLabel": "Entra ID Portal Audit info",
                  "postText": "Click here to see the audit of the object in the Entra ID portal",
                  "style": "link",
                  "icon": "Tasks",
                  "linkIsContextBlade": true,
                  "bladeOpenContext": {
                    "bladeName": "UserProfileMenuBlade",
                    "extensionName": "Microsoft_AAD_UsersAndTenants",
                    "bladeJsonParameters": "{\n  \"menuId\": \"Audit\",\n  \"userId\": \"{AccountDetails:$.AccountObjectId}\",\n  \"hidePreviewBanner~\": true\n}"
                  }
                }
              ]
            },
            "name": "UserEntraLinks"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "let Interrupted = dynamic([\"50058\", \"50148\", \"50140\", \"51006\", \"50059\", \"65001\", \"52004\", \"50055\", \"50144\", \"50072\", \"50074\", \"16000\", \"16001\", \"16003\", \"50127\", \"50125\", \"50129\", \"50143\", \"81010\", \"81014\", \"81012\"]);\r\nSigninLogs\r\n| where UserPrincipalName =~ \"{Account:label}\"\r\n| project TimeGenerated, ResultType\r\n| make-series TotalSuccess = countif(ResultType == 0), TotalInterrupt = countif(ResultType in (Interrupted) and ResultType != 0), TotalFailure = countif(ResultType !in (Interrupted) and ResultType != 0) on TimeGenerated from ago(30d) to now() step 1h",
              "size": 1,
              "title": "{AccountDetails:$.AccountDisplayName}'s sign-in activities for the last 30 days",
              "timeContext": {
                "durationMs": 2592000000
              },
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{SentinelWorkspace}"
              ],
              "visualization": "timechart",
              "chartSettings": {
                "seriesLabelSettings": [
                  {
                    "seriesName": "TotalSuccess",
                    "color": "green"
                  },
                  {
                    "seriesName": "TotalInterrupt",
                    "color": "orange"
                  },
                  {
                    "seriesName": "TotalFailure",
                    "color": "red"
                  }
                ]
              }
            },
            "name": "AccountSigninActivities"
          },
          {
            "type": 1,
            "content": {
              "json": "**Legend for related alerts**\r\n\r\n🟥 High severity alerts   \r\n🟧 Medium severity alerts     \r\n🟨 Low severity alerts   \r\n🟪 Informational severity alerts    \r\n",
              "style": "info"
            },
            "conditionalVisibility": {
              "parameterName": "ShowHelp",
              "comparison": "isEqualTo",
              "value": "Yes"
            },
            "name": "RelatedAlertsLegendHelp"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "let CurrentAlerts = dynamic({IncidentInfo:$.ListAlerts});\r\nSecurityAlert\r\n| where AlertName !~ \"\"\r\n| where SystemAlertId !in (CurrentAlerts)\r\n| summarize arg_max(TimeGenerated, *) by SystemAlertId\r\n| mv-apply todynamic(Entities) on (\r\n    where Entities.Type =~ \"account\"\r\n    | where Entities.Name =~ \"{AccountDetails:$.AccountUPN}\" or Entities.AadUserId == \"{AccountDetails:$.AccountObjectId}\"\r\n)\r\n| project TimeGenerated, AlertName, AlertSeverity, Status\r\n| order by TimeGenerated desc",
              "size": 1,
              "title": "Related alerts for {AccountDetails:$.AccountDisplayName} the last 30 days",
              "noDataMessage": "The user was not involved in any other alert the last 30 days.",
              "noDataMessageStyle": 3,
              "timeContext": {
                "durationMs": 2592000000
              },
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{SentinelWorkspace}"
              ],
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "AlertName",
                    "formatter": 18,
                    "formatOptions": {
                      "thresholdsOptions": "icons",
                      "thresholdsGrid": [
                        {
                          "sourceColumn": "AlertSeverity",
                          "operator": "==",
                          "thresholdValue": "Medium",
                          "representation": "Sev1",
                          "text": "{0}{1}"
                        },
                        {
                          "sourceColumn": "AlertSeverity",
                          "operator": "==",
                          "thresholdValue": "High",
                          "representation": "Sev0",
                          "text": "{0}{1}"
                        },
                        {
                          "sourceColumn": "AlertSeverity",
                          "operator": "==",
                          "thresholdValue": "Low",
                          "representation": "Sev2",
                          "text": "{0}{1}"
                        },
                        {
                          "sourceColumn": "AlertSeverity",
                          "operator": "Default",
                          "thresholdValue": null,
                          "representation": "Sev4",
                          "text": "{0}{1}"
                        }
                      ]
                    }
                  },
                  {
                    "columnMatch": "AlertSeverity",
                    "formatter": 5
                  }
                ]
              }
            },
            "name": "UserRelatedAlertsQuery"
          },
          {
            "type": 1,
            "content": {
              "json": "**Legend for Entra ID risks**\r\n\r\n🟥 High risk   \r\n🟧 Medium risk   \r\n🟪 Low risk\r\n\r\nYou can hover on the top of the risk and IP address to dispplay more data.\r\n",
              "style": "info"
            },
            "conditionalVisibility": {
              "parameterName": "ShowHelp",
              "comparison": "isEqualTo",
              "value": "Yes"
            },
            "name": "IdentityProtectionLegendHelp"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "AADUserRiskEvents\r\n| where TimeGenerated > ago(30d)\r\n| where UserPrincipalName =~ \"{AccountDetails:$.AccountUPN}\"\r\n| extend Location = strcat(Location.city, \" \", Location.state, \" \", Location.countryOrRegion )\r\n| project TimeGenerated, RiskEventType, DetectionTimingType, RiskLevel, RiskDetail, IpAddress, Location\r\n| order by TimeGenerated asc",
              "size": 1,
              "title": "{AccountDetails:$.AccountDisplayName} Entra ID risk 30-day history",
              "noDataMessage": "No risk associated to the user",
              "noDataMessageStyle": 3,
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{SentinelWorkspace}"
              ],
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "RiskEventType",
                    "formatter": 18,
                    "formatOptions": {
                      "thresholdsOptions": "icons",
                      "thresholdsGrid": [
                        {
                          "sourceColumn": "RiskLevel",
                          "operator": "==",
                          "thresholdValue": "low",
                          "representation": "Sev4"
                        },
                        {
                          "sourceColumn": "RiskLevel",
                          "operator": "==",
                          "thresholdValue": "medium",
                          "representation": "Sev2"
                        },
                        {
                          "sourceColumn": "RiskLevel",
                          "operator": "==",
                          "thresholdValue": "high",
                          "representation": "Sev0",
                          "text": "{0}{1}"
                        },
                        {
                          "operator": "Default",
                          "thresholdValue": null,
                          "representation": "Blank",
                          "text": "{0}{1}"
                        }
                      ]
                    },
                    "tooltipFormat": {
                      "tooltip": "[\"DetectionTimingType\"] detection type"
                    }
                  },
                  {
                    "columnMatch": "DetectionTimingType",
                    "formatter": 5
                  },
                  {
                    "columnMatch": "RiskLevel",
                    "formatter": 5
                  },
                  {
                    "columnMatch": "IpAddress",
                    "formatter": 0,
                    "tooltipFormat": {
                      "tooltip": "[\"Location\"]"
                    }
                  },
                  {
                    "columnMatch": "Location",
                    "formatter": 5
                  }
                ]
              }
            },
            "name": "RiskHistoryQuery"
          }
        ],
        "exportParameters": true
      },
      "customWidth": "50",
      "name": "AccountGroup"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 9,
            "content": {
              "version": "KqlParameterItem/1.0",
              "parameters": [
                {
                  "id": "ca7e10ff-a4db-4bad-8d92-336b33588543",
                  "version": "KqlParameterItem/1.0",
                  "name": "IPAddress",
                  "type": 11,
                  "isRequired": true,
                  "query": "SecurityIncident\r\n| where TimeGenerated > ago(90d)\r\n| where IncidentNumber  == {IncidentNumber}\r\n| summarize arg_max(TimeGenerated, * ) by IncidentNumber\r\n| mv-expand AlertId = AlertIds\r\n| extend AlertId = tostring(AlertId)\r\n| join (\r\n    SecurityAlert\r\n    | where TimeGenerated > ago(90d)\r\n    | summarize arg_max(TimeGenerated, * ) by SystemAlertId\r\n) on $left.AlertId == $right.SystemAlertId\r\n| mv-apply todynamic(Entities) on (\r\n    where Entities.Type =~ \"ip\"\r\n)\r\n| extend Address = tostring(Entities.Address)\r\n| distinct Address\r\n| serialize Rank = row_number()\r\n| project label = Address, value = Address, selected = iff(Rank == 1, true, false)",
                  "crossComponentResources": [
                    "{SentinelWorkspace}"
                  ],
                  "typeSettings": {
                    "additionalResourceOptions": [],
                    "showDefault": false
                  },
                  "queryType": 0,
                  "resourceType": "microsoft.operationalinsights/workspaces"
                },
                {
                  "id": "e19c0f39-3b1b-43b7-842d-0a26d9ca7300",
                  "version": "KqlParameterItem/1.0",
                  "name": "ThreatDetails",
                  "type": 1,
                  "query": "ThreatIntelligenceIndicator\r\n| where TimeGenerated > ago(14d)\r\n| where NetworkSourceIP == \"{IPAddress}\" or NetworkIP == \"{IPAddress}\"\r\n| summarize arg_max(TimeGenerated, *) by IndicatorId\r\n| extend Data = pack_all()\r\n| project Data",
                  "crossComponentResources": [
                    "{SentinelWorkspace}"
                  ],
                  "isHiddenWhenLocked": true,
                  "queryType": 0,
                  "resourceType": "microsoft.operationalinsights/workspaces"
                },
                {
                  "id": "89a4bc0a-8093-4bc1-b73f-346dff614757",
                  "version": "KqlParameterItem/1.0",
                  "name": "IPLookup",
                  "type": 1,
                  "query": "{\"version\":\"ARMEndpoint/1.0\",\"data\":null,\"headers\":[],\"method\":\"GET\",\"path\":\"/subscriptions/{SentinelWorkspace:subscriptionId}/resourceGroups/{SentinelWorkspace:resourcegroup}/providers/Microsoft.SecurityInsights/enrichment/ip/geodata/\",\"urlParams\":[{\"key\":\"api-version\",\"value\":\"2024-01-01-preview\"},{\"key\":\"ipAddress\",\"value\":\"{IPAddress}\"}],\"batchDisabled\":false,\"transformers\":[{\"type\":\"jsonpath\",\"settings\":{\"tablePath\":\"$\",\"columns\":[{\"path\":\"$\",\"columnid\":\"Data\"}]}}]}",
                  "isHiddenWhenLocked": true,
                  "queryType": 12
                }
              ],
              "style": "pills",
              "queryType": 12
            },
            "name": "IncidentParameters"
          },
          {
            "type": 1,
            "content": {
              "json": "## Threat Intel Details   \r\n\r\n**📆Valid until** {ThreatDetails:$.ExpirationDateTime}  \r\n**Confidence** {ThreatDetails:$.ConfidenceScore}%   \r\n**Description** {ThreatDetails:$.Description}   \r\n**IndicatorProvider** {ThreatDetails:$.IndicatorProvider}    \r\n**SourceSystem** {ThreatDetails:$.SourceSystem}   \r\n**ThreatType** {ThreatDetails:$.ThreatType}"
            },
            "customWidth": "50",
            "name": "ThreatDetailsText"
          },
          {
            "type": 1,
            "content": {
              "json": "## IP Details   \r\n\r\n**ASN** {IPLookup:$.asn}   \r\n**Organization** {IPLookup:$.organization}   \r\n**organizationType** {IPLookup:$.organizationType}   \r\n**Location** {IPLookup:$.city} {IPLookup:$.state} {IPLookup:$.country}    \r\n**Region** {IPLookup:$.region}   \r\n\r\n"
            },
            "customWidth": "50",
            "name": "IPDetailsText"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "{\"version\":\"1.0.0\",\"content\":\"{\\r\\n   \\\"latitude\\\": \\\"{IPLookup:$.latitude}\\\",\\r\\n   \\\"longitude\\\": \\\"{IPLookup:$.longitude}\\\",\\r\\n   \\\"Place\\\": \\\"{IPLookup:$.city}\\\"\\r\\n}\",\"transformers\":null}",
              "size": 0,
              "queryType": 8,
              "visualization": "map",
              "mapSettings": {
                "locInfo": "LatLong",
                "latitude": "latitude",
                "longitude": "longitude",
                "sizeSettings": "latitude",
                "sizeAggregation": "Sum",
                "labelSettings": "Place",
                "legendMetric": "Place",
                "legendAggregation": "Count",
                "itemColorSettings": {
                  "nodeColorField": "latitude",
                  "colorAggregation": "Sum",
                  "type": "heatmap",
                  "heatmapPalette": "greenRed"
                }
              }
            },
            "name": "query - 3"
          },
          {
            "type": 1,
            "content": {
              "json": "You can hover on the top of the sparklines under to see the total number of Entra ID sign-in attempts.\r\n\r\nIt also shows the number of unique users for this IP during that period for Enta ID. You can also click on the UserList column to see the list of users (limited to the first 256).\r\n",
              "style": "info"
            },
            "conditionalVisibility": {
              "parameterName": "ShowHelp",
              "comparison": "isEqualTo",
              "value": "Yes"
            },
            "name": "IPStatsHelp"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "let Interrupted = dynamic([\"50058\", \"50148\", \"50140\", \"51006\", \"50059\", \"65001\", \"52004\", \"50055\", \"50144\", \"50072\", \"50074\", \"16000\", \"16001\", \"16003\", \"50127\", \"50125\", \"50129\", \"50143\", \"81010\", \"81014\", \"81012\"]);\r\nSigninLogs\r\n| where IPAddress == \"{IPAddress}\"\r\n| project TimeGenerated, ResultType, IPAddress\r\n| make-series TotalSuccess = countif(ResultType == 0), TotalInterrupt = countif(ResultType in (Interrupted) and ResultType != 0), TotalFailure = countif(ResultType !in (Interrupted) and ResultType != 0) on TimeGenerated from ago(30d) to now() step 1h by IPAddress\r\n| join (\r\n    SigninLogs\r\n    | where IPAddress == \"{IPAddress}\"\r\n    | summarize UserList = make_set(UserPrincipalName, 256), UniqueUserCount = dcount(UserId) by IPAddress\r\n) on IPAddress\r\n| extend SumSuccess = array_sum(TotalSuccess), SumInterrupt = array_sum(TotalInterrupt), SumFailure = array_sum(TotalFailure)\r\n| project TotalSuccess, TotalInterrupt, TotalFailure, UniqueUserCount, SumSuccess, SumInterrupt, SumFailure, UserList",
              "size": 4,
              "title": "{IPAddress} stats for the last 30 days",
              "timeContext": {
                "durationMs": 2592000000
              },
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{SentinelWorkspace}"
              ],
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "TotalSuccess",
                    "formatter": 9,
                    "formatOptions": {
                      "palette": "green"
                    },
                    "tooltipFormat": {
                      "tooltip": "[\"SumSuccess\"] in the last 30 days"
                    }
                  },
                  {
                    "columnMatch": "TotalInterrupt",
                    "formatter": 9,
                    "formatOptions": {
                      "palette": "orange"
                    },
                    "tooltipFormat": {
                      "tooltip": "[\"SumInterrupt\"] in the last 30 days"
                    }
                  },
                  {
                    "columnMatch": "TotalFailure",
                    "formatter": 9,
                    "formatOptions": {
                      "palette": "red"
                    },
                    "tooltipFormat": {
                      "tooltip": "[\"SumFailure\"] in the last 30 days"
                    }
                  },
                  {
                    "columnMatch": "SumSuccess",
                    "formatter": 5
                  },
                  {
                    "columnMatch": "SumInterrupt",
                    "formatter": 5
                  },
                  {
                    "columnMatch": "SumFailure",
                    "formatter": 5
                  },
                  {
                    "columnMatch": "UserList",
                    "formatter": 7,
                    "formatOptions": {
                      "linkTarget": "CellDetails",
                      "linkLabel": "See user list",
                      "linkIsContextBlade": true,
                      "customColumnWidthSetting": "13.5714ch"
                    }
                  }
                ],
                "labelSettings": [
                  {
                    "columnId": "UniqueUserCount",
                    "label": "UniqueUser"
                  }
                ]
              }
            },
            "name": "IPAddressStatsQuery"
          },
          {
            "type": 1,
            "content": {
              "json": "You can hover on the top of the sparklines under to see the total number of Entra ID sign-in attempts for {AccountDetails:$.AccountUPN}.\r\n\r\nIt also shows the number of unique IPs used by this user in this period for Enta ID.\r\n",
              "style": "info"
            },
            "conditionalVisibility": {
              "parameterName": "ShowHelp",
              "comparison": "isEqualTo",
              "value": "Yes"
            },
            "name": "IPUserStatsHelp"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "let Interrupted = dynamic([\"50058\", \"50148\", \"50140\", \"51006\", \"50059\", \"65001\", \"52004\", \"50055\", \"50144\", \"50072\", \"50074\", \"16000\", \"16001\", \"16003\", \"50127\", \"50125\", \"50129\", \"50143\", \"81010\", \"81014\", \"81012\"]);\r\nSigninLogs\r\n| where IPAddress == \"{IPAddress}\"\r\n| where UserPrincipalName =~ \"{AccountDetails:$.AccountUPN}\"\r\n| project TimeGenerated, ResultType, UserPrincipalName\r\n| make-series TotalSuccess = countif(ResultType == 0), TotalInterrupt = countif(ResultType in (Interrupted) and ResultType != 0), TotalFailure = countif(ResultType !in (Interrupted) and ResultType != 0) on TimeGenerated from ago(30d) to now() step 1h by UserPrincipalName\r\n| join (\r\n    SigninLogs\r\n    | where UserPrincipalName == \"{AccountDetails:$.AccountUPN}\"\r\n    | summarize IPs = make_set(IPAddress, 256), UniqueIPCount = dcount(IPAddress) by UserPrincipalName\r\n) on UserPrincipalName\r\n| extend SumSuccess = array_sum(TotalSuccess), SumInterrupt = array_sum(TotalInterrupt), SumFailure = array_sum(TotalFailure)\r\n| project TotalSuccess, TotalInterrupt, TotalFailure, UniqueIPCount, SumSuccess, SumInterrupt, SumFailure, IPs",
              "size": 4,
              "title": "{IPAddress} stats for {AccountDetails:$.AccountUPN} for the last 30 days",
              "timeContext": {
                "durationMs": 2592000000
              },
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{SentinelWorkspace}"
              ],
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "TotalSuccess",
                    "formatter": 9,
                    "formatOptions": {
                      "palette": "green"
                    },
                    "tooltipFormat": {
                      "tooltip": "[\"SumSuccess\"] in the last 30 days"
                    }
                  },
                  {
                    "columnMatch": "TotalInterrupt",
                    "formatter": 9,
                    "formatOptions": {
                      "palette": "orange"
                    },
                    "tooltipFormat": {
                      "tooltip": "[\"SumInterrupt\"] in the last 30 days"
                    }
                  },
                  {
                    "columnMatch": "TotalFailure",
                    "formatter": 9,
                    "formatOptions": {
                      "palette": "red"
                    },
                    "tooltipFormat": {
                      "tooltip": "[\"SumFailure\"] in the last 30 days"
                    }
                  },
                  {
                    "columnMatch": "SumSuccess",
                    "formatter": 5
                  },
                  {
                    "columnMatch": "SumInterrupt",
                    "formatter": 5
                  },
                  {
                    "columnMatch": "SumFailure",
                    "formatter": 5
                  },
                  {
                    "columnMatch": "IPs",
                    "formatter": 7,
                    "formatOptions": {
                      "linkTarget": "CellDetails",
                      "linkLabel": "See IPs",
                      "linkIsContextBlade": true
                    }
                  }
                ],
                "labelSettings": [
                  {
                    "columnId": "UniqueIPCount",
                    "label": "UniqueIP"
                  }
                ]
              }
            },
            "name": "IPAddressUserStatsQuery"
          }
        ],
        "exportParameters": true
      },
      "customWidth": "50",
      "name": "IPGroup"
    },
    {
      "type": 1,
      "content": {
        "json": "Review the activities which have triggered the incident. Look at the resources which were touched and the types of actions. Also note if the action was a success or a failure.",
        "style": "info"
      },
      "conditionalVisibility": {
        "parameterName": "ShowHelp",
        "comparison": "isEqualTo",
        "value": "Yes"
      },
      "name": "ReviewActivityHelp"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "AzureActivity\r\n| where TimeGenerated between (datetime(\"{IncidentInfo:$.FirstActivityTime}\")..datetime(\"{IncidentInfo:$.LastActivityTime}\"))\r\n| where Caller =~ \"{AccountDetails:$.AccountUPN}\" and CallerIpAddress =~ \"{IPAddress}\"\r\n| project TimeGenerated, Level, ResourceProviderValue, _ResourceId, ResourceGroup, OperationNameValue, ActivityStatusValue\r\n| order by TimeGenerated asc",
        "size": 2,
        "title": "Azure activities between {IncidentInfo:$.FirstActivityTime} and {IncidentInfo:$.LastActivityTime}",
        "showExportToExcel": true,
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces",
        "crossComponentResources": [
          "{SentinelWorkspace}"
        ],
        "gridSettings": {
          "formatters": [
            {
              "columnMatch": "Level",
              "formatter": 5
            },
            {
              "columnMatch": "ResourceProviderValue",
              "formatter": 5
            },
            {
              "columnMatch": "OperationNameValue",
              "formatter": 18,
              "formatOptions": {
                "thresholdsOptions": "icons",
                "thresholdsGrid": [
                  {
                    "sourceColumn": "Level",
                    "operator": "==",
                    "thresholdValue": "Information",
                    "representation": "1",
                    "text": "{0}{1}"
                  },
                  {
                    "sourceColumn": "Level",
                    "operator": "==",
                    "thresholdValue": "Warning",
                    "representation": "2",
                    "text": "{0}{1}"
                  },
                  {
                    "sourceColumn": "Level",
                    "operator": "==",
                    "thresholdValue": "Error",
                    "representation": "3",
                    "text": "{0}{1}"
                  },
                  {
                    "operator": "Default",
                    "thresholdValue": null,
                    "representation": "Blank",
                    "text": "{0}{1}"
                  }
                ]
              }
            },
            {
              "columnMatch": "ActivityStatusValue",
              "formatter": 1
            }
          ],
          "rowLimit": 500,
          "filter": true,
          "hierarchySettings": {
            "treeType": 1,
            "groupBy": [
              "ResourceProviderValue"
            ],
            "expandTopLevel": true
          },
          "labelSettings": [
            {
              "columnId": "ResourceProviderValue",
              "label": "Type"
            },
            {
              "columnId": "_ResourceId",
              "label": "Resource"
            },
            {
              "columnId": "OperationNameValue",
              "label": "Action"
            },
            {
              "columnId": "ActivityStatusValue",
              "label": "Status"
            }
          ]
        }
      },
      "name": "AzureActivityListQuery"
    },
    {
      "type": 1,
      "content": {
        "json": "You can direcly take actions against this incident in Sentinel.\r\n\r\nNote that this currently not implemented. ",
        "style": "info"
      },
      "conditionalVisibility": {
        "parameterName": "ShowHelp",
        "comparison": "isEqualTo",
        "value": "Yes"
      },
      "name": "ActionListHelp"
    },
    {
      "type": 9,
      "content": {
        "version": "KqlParameterItem/1.0",
        "parameters": [
          {
            "id": "fd5bc5cd-519a-4561-b3c5-7318f7b5d903",
            "version": "KqlParameterItem/1.0",
            "name": "IncidentDetails",
            "type": 1,
            "isRequired": true,
            "query": "{\"version\":\"ARMEndpoint/1.0\",\"data\":null,\"headers\":[],\"method\":\"GET\",\"path\":\"{SentinelWorkspace}/providers/Microsoft.SecurityInsights/incidents/{IncidentInfo:$.IncidentName}\",\"urlParams\":[{\"key\":\"api-version\",\"value\":\"2024-01-01-preview\"}],\"batchDisabled\":false,\"transformers\":[{\"type\":\"jsonpath\",\"settings\":{\"tablePath\":\"$\",\"columns\":[{\"path\":\"$\",\"columnid\":\"Data\"}]}}]}",
            "isHiddenWhenLocked": true,
            "timeContext": {
              "durationMs": 86400000
            },
            "queryType": 12
          }
        ],
        "style": "pills",
        "queryType": 12
      },
      "name": "GatherInfoForActionParameters"
    },
    {
      "type": 11,
      "content": {
        "version": "LinkItem/1.0",
        "style": "toolbar",
        "links": [
          {
            "id": "501b7933-12b3-4543-bc22-8804a6d470fd",
            "linkTarget": "ArmAction",
            "linkLabel": "Close the incident",
            "postText": "Close the incident as false positive",
            "style": "link",
            "icon": "Close",
            "linkIsContextBlade": true,
            "armActionContext": {
              "path": "{SentinelWorkspace}/providers/Microsoft.SecurityInsights/incidents/{IncidentInfo:$.IncidentName}",
              "headers": [],
              "params": [
                {
                  "key": "api-version",
                  "value": "2024-01-01-preview"
                }
              ],
              "body": "{\r\n  \"properties\": {\r\n    \"status\": \"Closed\",\r\n    \"classification\": \"FalsePositive\",\r\n    \"classificationReason\": \"InaccurateData\",\r\n    \"classificationComment\": \"Closed from the workbook\"\r\n  }\r\n}",
              "httpMethod": "POST",
              "title": "Closing incident",
              "description": "# NOT IMPLEMENTED AT THE MOMENT"
            }
          },
          {
            "id": "ca97a408-f10a-4766-810f-2cb240436b4f",
            "linkTarget": "ArmAction",
            "linkLabel": "Raise severity",
            "postText": "Raise the severity to the highest level",
            "style": "link",
            "icon": "Fired",
            "linkIsContextBlade": true,
            "armActionContext": {
              "headers": [],
              "params": [],
              "httpMethod": "POST",
              "description": "# NOT IMPLEMENTED AT THE MOMENT"
            }
          }
        ]
      },
      "name": "ActionList"
    }
  ],
  "fromTemplateId": "sentinel-UserWorkbook",
  "$schema": "https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"
}
